"use strict";

// Global vars
var windowWidth = $(window).width();
var desktopMin = 768;
var WHOCms = {
  verticalListHighlight: function verticalListHighlight() {
    // vertical list full width with highlight
    var list = $('.vertical-list--full-width');
    list.each(function () {
      // Added flexbox wrap classes
      $(this).addClass('flex-row');
      $(this).children().first().addClass('vertical-list-item--highlight').wrapAll("<div class='flex-col flex-col-4'></div>"); // first element

      $(this).children().not(':first-child').wrapAll("<div class='flex-col flex-col-8'></div>"); // all element except the first
    });
  },
  movedNavigationSearchToHeader: function movedNavigationSearchToHeader() {
    if ($('.top-header .navigation-search').length) {
      var search = $('.top-header .navigation-search');
      ;
      search.clone().insertAfter('.main-header .header-logo');
    }
  },
  searchOverlay: function searchOverlay() {
    var that = this;
    var headerContainer = $('.main-header .container, .top-header .container'),
        navigationContainer = $('.navigation-search'),
        searchForm = $('#search-form'),
        searchInput = $('.searchInput');

    if (navigationContainer.length && searchForm.length) {
      // Clone markup
      if (!headerContainer.find('.navigation-search').length) {
        headerContainer.append(navigationContainer.clone(true));
      } // Overlay


      if (!$('.search-overlay').length) {
        $('#search-form').wrapAll('<div class="search-overlay"><div class="wrapper"></div></div>');
        $('.search-overlay').prepend('<span class="closebtn">&times;</span>');
      } // Vars


      var searchTrigger = headerContainer.find('.navigation-search'); // Handlers

      $(document).on('click', '.closebtn', function () {
        $('body').removeClass('search-open');
        searchInput.val(' ');
      });
      $(document).on('click', '.navigation-search', function () {
        that.slideUpMainNavDropdown();

        if (!$('.search-open').length) {
          $('body').addClass('search-open');
        }
      });
      $(document).on('click', '#clear-search', function () {
        searchInput.val(' ');
      }); // IOS/Safari only "accepts" the focus when the event inside a touch event handler

      $(document).on('touchstart', '.navigation-search', function () {
        that.slideUpMainNavDropdown();
        searchInput.trigger('focus');
      });
    }
  },
  slideUpMainNavDropdown: function slideUpMainNavDropdown() {
    $('.navWrapper ul.nav').find('.open').removeClass('open');
    $('.navWrapper .navItemLayout').slideUp();
    $('body').removeClass('mainnav_overlay-visible');
  },
  setUpEqualHeight: function setUpEqualHeight() {
    // math height lib
    var row = $('.row');
    row.each(function () {
      if (typeof matchHeight === 'function' && $.isFunction(matchHeight)) {
        $(this).find('.highlight-widget.title-and-summary').matchHeight();
      } else {// console.log('Missing library.')
      }
    });
  },
  expandableList: function expandableList() {
    // trigger event for List.ExapndableList mvc widget
    $('[data-sf-role=toggleLink]').on('click', function () {
      var link = $(this);
      var icon = link.find('.sf-icon');

      if (link.hasClass("expanded")) {
        link.parent().removeClass("expanded");
      } else {
        link.parent().addClass("expanded");
      }
    });
  },
  backgroundWidget: function backgroundWidget() {
    //Background color/image widget
    var backgroundURLHolder = $('.background-url-holder');

    if (backgroundURLHolder != null) {
      backgroundURLHolder.each(function () {
        var self = $(this);
        var imageURL = self.find('img'),
            //imgTag = $('<img class="background-img" src="' + imageURL + '">'),
        bgColor = self.attr('data-color'),
            bgImage = self.closest('.background-widget').addClass(bgColor);

        if (imageURL) {
          self.closest('.background-widget').addClass('bg-image'); //imgTag.appendTo(self.closest('.background-widget'));       
        }
      });
    }
  },
  clickableHeroImage: function clickableHeroImage() {
    var heroImageContainer = $('.hero-image');

    if (heroImageContainer != undefined) {
      heroImageContainer.on('hover', function () {
        var url = $(this).attr('data-url');

        if (url && url !== "") {
          $(this).css({
            cursor: 'pointer'
          });
        }
      });
      heroImageContainer.on('click', function () {
        var url = $(this).attr('data-url');
        var target = $(this).attr('target');

        if (url && url !== "") {
          window.open(url, target);
        }
      });
    }
  },
  heroImageModernizr: function heroImageModernizr() {
    if (!Modernizr.objectfit) {
      $('.hero-image').each(function () {
        var $container = $(this),
            imgUrl = $container.find('img').prop('src');

        if (imgUrl) {
          $container.css('backgroundImage', 'url(' + imgUrl + ')').addClass('compat-object-fit');
        }
      });
    }
  },
  accordionNav: function accordionNav() {
    $('.accordion-navigation .toggle').click(function (e) {
      e.preventDefault();
      var $this = $(this);

      if ($this.next().hasClass('active')) {
        $this.removeClass('active');
        $this.next().removeClass('active');
        $this.next().slideUp(350);
      } else {
        $this.removeClass('active');
        $this.parent().parent().find('li .accordion-navigation--sublevel').removeClass('active');
        $this.parent().parent().find('li .accordion-navigation--sublevel').slideUp(350);
        $this.parent().parent().find('li .toggle.active').removeClass('active');
        $this.toggleClass('active');
        $this.next().toggleClass('active');
        $this.next().slideToggle(350);
      }
    });
  },
  countMultimediaItems: function countMultimediaItems() {
    var multimediaRow = $('.multimedia-row'),
        multimediaRowItems = multimediaRow.children();
    var twoCols = $('<div class="sf_colsIn col-md-6"></div >'),
        threeCols = $('<div class="sf_colsIn col-md-4"></div >'),
        fourCols = $('<div class="sf_colsIn col-md-3"></div >');

    if (multimediaRowItems.length >= 2) {
      multimediaRow.addClass('visible');
      $('.multimedia-row-heading').addClass('visible');
    }

    if (multimediaRowItems.length === 2) {
      multimediaRow.each(function () {
        $(this).children().wrap(twoCols);
      });
    }

    if (multimediaRowItems.length === 3) {
      multimediaRow.each(function () {
        $(this).children().wrap(threeCols);
      });
    }

    if (multimediaRowItems.length === 4) {
      multimediaRow.each(function () {
        $(this).children().wrap(fourCols);
      });
    }
  },
  initSelect2InDetailsPage: function initSelect2InDetailsPage() {
    var dropdown = $('.sf-detail-body-container select.sf-dropdown');
    dropdown.each(function () {
      var select = $(this);
      select.select2({
        minimumResultsForSearch: -1,
        placeholder: function placeholder() {
          $(this).data('placeholder');
        }
      });
      select.on('select2:selecting', function (e) {
        window.location = e.params.args.data.id;
      });
    });
  },
  initYouTubeVideoPlayer: function initYouTubeVideoPlayer() {
    if ($('.player').length) {
      setTimeout(function () {
        $('.player').mb_YTPlayer();
      }, 1000);
    }
  },
  removeEmptyColumns: function removeEmptyColumns() {
    $('.sf_colsIn').each(function () {
      if ($.trim($(this).text()).length == 0) {
        if ($(this).children().length == 0) {
          $(this).text('');
          $(this).addClass('empty');
        }
      }
    });
  },
  gridMatchHeights: function gridMatchHeights() {
    //Horizontal list viw items
    $('.matching-height').each(function () {
      $('.matching-height--item').matchHeight();
    });
  },
  formsSelect2Dropdown: function formsSelect2Dropdown() {
    $("[data-sf-role='dropdown-list-field-container'] select").select2({
      containerCssClass: "sf-forms-dropdown-container",
      dropdownCssClass: "sf-forms-dropdown-list"
    });
  },
  formsFileUploadLabel: function formsFileUploadLabel() {
    $('input[type="file"]').each(function () {
      $(this).change(function (e) {
        var fileName = e.target.files[0].name;
        var label = $(".file-input-name");
        label.empty();
        label.append(fileName);
      });
    });
  },
  mainNavAZlistFilterHTList: function mainNavAZlistFilterHTList() {
    var azListInMainNav = $('.a-z--list'),
        hashUrlValue = window.location.hash != "" ? window.location.hash.split('#')[1] : "";

    var triggerLetter = function triggerLetter(letter) {
      var lowerCaseLetter = letter.toString().toLowerCase();

      if ($('.ln-letters').length && $('.ln-letters a' + lowerCaseLetter)) {
        $('.ln-letters a' + lowerCaseLetter).trigger("click");
        $('html,body').animate({
          scrollTop: $('.ln-letters').offset().top
        }, 1000);
      } else {
        $('.ln-letters a' + '.all').trigger("click");
      }
    }; // on click


    azListInMainNav.find('li a').click(function () {
      var linkHref = $(this).html();
      triggerLetter(linkHref);
    }); // on load

    if (hashUrlValue != "") {
      triggerLetter(hashUrlValue);
    }
  },
  healhTopiclistMainNavScroll: function healhTopiclistMainNavScroll() {
    var filteredList = $("#alphabetical-nav-filter-nav"),
        filteredListItem = filteredList.find('.ln-selected').not(".all");

    if (filteredListItem.length) {
      setTimeout(function () {
        $('html,body').animate({
          scrollTop: filteredListItem.offset().top - 50
        }, 1000);
      }, 1000);
    }
  },
  moreContent: function moreContent() {
    $('div[data-class]').each(function () {
      var self = $(this);
      var dataClassVal = self.data('class');

      if (dataClassVal === 'more-content') {
        self.addClass('more-content');
      }

      if (dataClassVal === 'more-content-inner') {
        self.addClass('more-content-inner');
      }

      if (dataClassVal === 'more-button') {
        self.addClass('more-button');
      }

      if (dataClassVal === 'more-button-label') {
        self.addClass('more-button-label');

        if (self.find('text')[0]) {
          self.attr('data-close', self.find('text')[0].innerHTML);
        }

        if (self.find('text')[1]) {
          self.attr('data-open', self.find('text')[1].innerHTML);
        }
      }
    });
    var moreButton = $('.more-button');
    var moreContent = $('.more-content');
    moreButton.on('click', function () {
      var self = $(this);
      var moreContent = self.prev();
      var moreContentInner = moreContent.find('.more-content-inner');

      if (self.hasClass('open')) {
        moreContent.height(0);
        self.removeClass('open');
        moreContent.removeClass('visible');
      } else {
        moreContent.height(moreContentInner.height());
        self.addClass('open');
        moreContent.addClass('visible');
      }
    });

    for (var x = moreContent.filter('.visible'), y = 0; y < x.length; y++) {
      $(x[y]).height($(x[y]).find('.more-content-inner').height());
    }
  },
  imageCredit: function imageCredit() {
    var that = this;
    var credit = $('.sf-image-credit'),
        creditContent = $('.sf-image-credit__content'),
        creditTriggerLabel = $('.sf-image-credit__label');

    for (var x = creditContent.filter('.visible'), y = 0; y < x.length; y++) {
      $(x[y]).height($(x[y]).find('.sf-image-credit__inner').innerHeight());
    }

    $('.sf-image-credit').each(function () {
      var _self = $(this),
          creditContent = _self.find('.sf-image-credit__content'),
          creditInner = _self.find('.sf-image-credit__inner'),
          creditTriggerLabel = _self.find('.sf-image-credit__label');

      _self.show();

      creditTriggerLabel.on('click', function () {
        if (creditContent.hasClass('visible')) {
          creditContent.height(0);
          creditContent.removeClass('visible');
          $(this).removeClass('active');

          _self.removeClass('expanded');
        } else {
          creditContent.addClass('visible');
          $(this).addClass('active');

          _self.addClass('expanded');

          creditContent.height(creditInner.innerHeight());
        }
      });
    });
    $(window).resize(function () {
      var width = $(window).width();

      if (credit.hasClass('expanded')) {
        creditContent.height(0);
        creditContent.removeClass('visible');
        creditTriggerLabel.removeClass('active');
        credit.removeClass('expanded');
      }

      that.imageCreditBreakpointClass();
    });
  },
  imageCreditBreakpointClass: function imageCreditBreakpointClass() {
    var credit = $('.sf-image-credit');
    credit.each(function () {
      var _self = $(this);

      var _selfContainterWidth = _self.closest('div[class*="col-"]').width();

      if (_selfContainterWidth != null) {
        _self.removeClass('desktop-medium desktop tablet mobile-large mobile'); //console.log(_self);


        if (_selfContainterWidth >= 1280) {
          _self.addClass('desktop-medium');
        }

        if (_selfContainterWidth >= 1020 && _selfContainterWidth < 1280) {
          _self.addClass('desktop');
        }

        if (_selfContainterWidth >= 768 && _selfContainterWidth < 1020) {
          _self.addClass('tablet');
        }

        if (_selfContainterWidth >= 600 && _selfContainterWidth < 768) {
          _self.addClass('mobile-large');
        }

        if (_selfContainterWidth < 600) {
          _self.addClass('mobile');
        }
      }
    });
  },
  initTabs: function initTabs() {
    if (window.tabsJs === undefined) {
      window.tabsJs = true;
      var script = document.createElement('script');
      script.setAttribute('type', 'text/javascript');
      script.setAttribute('src', '/ResourcePackages/WHO/assets/dist/scripts/gridTabs.min.js');
      document.body.appendChild(script);
    }
  },
  initStepTabs: function initStepTabs() {
    if (window.stepTabs === undefined) {
      window.stepTabs = true;
      var script = document.createElement('script');
      script.setAttribute('type', 'text/javascript');
      script.setAttribute('src', '/ResourcePackages/WHO/assets/dist/scripts/step-tabs.min.js');
      document.body.appendChild(script);
    }
  },
  trimTextToContainer: function trimTextToContainer() {
    // fixed height container divisible to the line height of the text e.g. 32/16  or 36/12
    var containers = document.querySelectorAll('.sf-list-vertical__title'),
        hiddenSelector = '.full-title',
        // child of container
    elToTrimSelector = '.trimmed'; // child of conainer

    function trimTitles() {
      containers.forEach(function (container) {
        // Loop through each container
        var fullTitle = container.querySelector(hiddenSelector);
        var span = container.querySelector(elToTrimSelector); // Reset span text on resize

        if (span && fullTitle) {
          span.textContent = fullTitle.textContent; // When making the screen bigger, copy the full title first

          var titleHeight = container.clientHeight;

          while (span.offsetHeight > titleHeight && span.textContent.length > 30) {
            span.textContent = span.textContent.replace(/\W*\s(\S)*$/, '...'); // add an ellipsis at the last shown space
          }
        }
      });
    }

    ;
    trimTitles();
    window.addEventListener('resize', trimTitles);
  },
  init: function init() {
    $(function () {
      $('img.lazy').lazy({
        effect: "fadeIn",
        effectTime: 2000,
        threshold: 0
      });
    });
    this.gridMatchHeights(); //Search

    this.searchOverlay();
    this.setUpEqualHeight(); //List

    this.verticalListHighlight();
    this.expandableList();
    this.backgroundWidget(); // Hero image

    this.clickableHeroImage();
    this.heroImageModernizr();
    this.accordionNav();
    this.movedNavigationSearchToHeader();
    this.initSelect2InDetailsPage();
    this.countMultimediaItems();
    this.initYouTubeVideoPlayer();
    this.removeEmptyColumns(); //Forms

    this.formsSelect2Dropdown();
    this.formsFileUploadLabel(); //A-Z HT list filtrations
    //this.mainNavAZlistFilterHTList();

    this.healhTopiclistMainNavScroll();
    this.moreContent();
    this.imageCredit();
    this.imageCreditBreakpointClass();
    this.initTabs();
    this.initStepTabs();
    this.trimTextToContainer();
  }
};
$(function () {
  WHOCms.init();
});

var pubSubEvents = function () {
  var subscribers = {
    "hubsUpdate": []
  };
  return {
    publish: function publish(eventName, data) {
      if (!subscribers[eventName]) return;
      subscribers[eventName].forEach(function (subscriberCallback) {
        subscriberCallback(data != undefined ? data : {});
      });
    },
    subscribe: function subscribe(eventName, callback) {
      if (!subscribers[eventName]) {
        subscribers[eventName] = [];
      }

      subscribers[eventName].push(callback);
      return {
        unsubscribe: function unsubscribe() {
          subscribers[eventName].splice(index, 1);
        }
      };
    }
  };
}();
//# sourceMappingURL=main.min.js.map
